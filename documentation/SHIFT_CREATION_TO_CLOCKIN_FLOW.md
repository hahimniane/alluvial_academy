# Shift Creation to Clock-In Flow with Zoom Integration

## Overview

This document provides a comprehensive guide to understanding how a shift is created from the moment an admin fills out the form, through Zoom meeting setup, to when a teacher clocks in. This includes all file references, function calls, and data flow.

---

## Phase 1: Shift Creation

### Entry Point: Admin Creates Shift via UI

**File:** `lib/features/shift_management/widgets/create_shift_dialog.dart`

**Process:**
1. Admin fills out form with:
   - Teacher selection (from users collection)
   - Student selection (for teaching shifts)
   - Subject selection
   - Date/time selection (with timezone)
   - Recurrence settings (optional)
   - Category (teaching/leadership)
   - Hourly rate (optional, otherwise uses subject default or teacher default)

2. On form submission, calls:
   ```dart
   await ShiftService.createShift(...)
   ```
   **Location:** Line ~2751 in `create_shift_dialog.dart`

---

### ShiftService.createShift() - Core Creation Logic

**File:** `lib/core/services/shift_service.dart`  
**Method:** `createShift()` (starts at line ~177)

**Step-by-step process:**

1. **Authentication Check**
   - Verifies current user is authenticated
   - Gets current user ID for `createdByAdminId`

2. **Conflict Detection**
   ```dart
   final hasConflict = await hasConflictingShift(
     teacherId: teacherId,
     shiftStart: shiftStart,
     shiftEnd: shiftEnd,
   );
   ```
   - Checks for overlapping shifts for the same teacher
   - Prevents double-booking

3. **Teacher Data Lookup**
   ```dart
   final teacherDoc = await _firestore.collection('users').doc(teacherId).get();
   ```
   - Fetches teacher information:
     - Teacher name (`first_name` + `last_name`)
     - Teacher timezone (defaults to 'UTC' if not set)
     - Default wage (for hourly rate calculation)

4. **Hourly Rate Determination**
   Priority order:
   - Provided `hourlyRate` parameter
   - Subject's `defaultWage` (if `subjectId` provided)
   - Teacher's default wage from user document
   - Falls back to 0.0 if none found

5. **Student Name Resolution**
   - Converts student UIDs to display names
   - Handles email-to-UID conversion if needed

6. **Auto-Generated Name Creation**
   ```dart
   final autoGeneratedName = TeachingShift.generateAutoName(
     teacherName: teacherName,
     subject: subject,
     studentNames: finalStudentNames,
   );
   ```

7. **Shift Object Creation**
   Creates `TeachingShift` model instance with:
   - `status: ShiftStatus.scheduled` (initial status)
   - All provided data
   - `createdAt: DateTime.now()`
   - Timezone information (admin and teacher)
   - Recurrence settings if provided

8. **Firestore Write**
   ```dart
   await shiftDoc.set(shift.toFirestore());
   ```
   - Collection: `teaching_shifts`
   - Document ID: Auto-generated

9. **Schedule Lifecycle Tasks**
   ```dart
   await _scheduleShiftLifecycleTasks(shift);
   ```
   - Calls Cloud Function to schedule automated tasks
   - If this fails, shift document is rolled back (deleted)

10. **Recurrence Handling** (if applicable)
    - If recurrence pattern specified, generates recurring shift instances
    - Each recurring shift also goes through lifecycle scheduling

---

### _scheduleShiftLifecycleTasks() - Cloud Tasks Scheduling

**File:** `lib/core/services/shift_service.dart`  
**Method:** `_scheduleShiftLifecycleTasks()` (line ~138)

**Process:**

1. **Cloud Function Call**
   ```dart
   final callable = _functions.httpsCallable('scheduleShiftLifecycle');
   final payload = {
     'shiftId': shift.id,
     'teacherId': shift.teacherId,
     'shiftStart': shift.shiftStart.toUtc().toIso8601String(),
     'shiftEnd': shift.shiftEnd.toUtc().toIso8601String(),
     'status': shift.status.name,
     'cancel': cancel,
     'adminTimezone': shift.adminTimezone,
     'teacherTimezone': shift.teacherTimezone,
   };
   await callable.call(payload);
   ```

**Purpose:** Schedules Cloud Tasks for shift start and end automation

---

### Cloud Function: scheduleShiftLifecycle

**File:** `functions/handlers/shifts.js`  
**Function:** `scheduleShiftLifecycle` (line ~66)  
**Type:** Callable (`onCall`)

**What it does:**

1. **Creates Two Cloud Tasks:**
   - **Start Task** - Scheduled for `shiftStart` time
     - Calls `handleShiftStartTask` HTTP function
     - Marks shift as `active` at start time
   
   - **End Task** - Scheduled for `shiftEnd` time
     - Calls `handleShiftEndTask` HTTP function
     - Auto clock-out, calculates worked minutes, sets final status

2. **Task Configuration:**
   - Queue: `shift-lifecycle-queue` (in `us-central1`)
   - Uses service account for authentication
   - Tasks execute even if no one is online

3. **Zoom Meeting Creation (Non-blocking)**
   ```javascript
   try {
     await ensureZoomMeetingAndEmailTeacher({shiftId, shiftData});
   } catch (zoomError) {
     // Logs error but doesn't fail shift creation
     await shiftRef.update({ zoom_error: String(zoomError.message) });
   }
   ```
   - Creates Zoom meeting if shift is teaching category
   - Sends email invite to teacher
   - Errors don't prevent shift creation

**Note:** Zoom meeting creation happens automatically during shift creation via Cloud Function.

---

## Phase 2: Zoom Meeting Creation

### ensureZoomMeetingAndEmailTeacher()

**File:** `functions/services/zoom/shift_zoom.js`  
**Function:** `ensureZoomMeetingAndEmailTeacher()` (line ~20)

**Conditions for Zoom Meeting:**
- Shift category must be `'teaching'` (not leadership)
- Shift must not be cancelled
- Shift must have a `teacher_id`
- Teacher must have an email address
- Zoom must be configured (environment variables in `.env`)

**Zoom Configuration Required (in `functions/.env`):**
```
ZOOM_ACCOUNT_ID=...
ZOOM_CLIENT_ID=...
ZOOM_CLIENT_SECRET=...
ZOOM_HOST_USER=...
ZOOM_JOIN_TOKEN_SECRET=...
ZOOM_ENCRYPTION_KEY_B64=...
```

**Process:**

1. **Check for Existing Meeting**
   ```javascript
   const hasExistingMeeting = Boolean(
     shiftData.zoom_meeting_id && 
     shiftData.zoom_encrypted_join_url
   );
   ```
   - If meeting exists and invite was sent, skips creation

2. **Create Zoom Meeting** (if needed)
   ```javascript
   const meeting = await createMeeting({
     topic,                    // Shift name/subject
     startTimeIso,            // Shift start time in ISO format
     durationMinutes,         // Calculated from shift duration
     agenda,                  // Description
     timezone: 'UTC',
   });
   ```
   - **File:** `functions/services/zoom/client.js`
   - Uses Zoom API to create scheduled meeting
   - Returns meeting ID and join URL

3. **Encrypt Join URL**
   ```javascript
   const encryptedJoinUrl = encryptString(
     meeting.joinUrl, 
     zoomConfig.encryptionKeyB64
   );
   ```
   - **File:** `functions/services/zoom/crypto.js`
   - Encrypts join URL before storing in Firestore
   - Uses AES encryption with base64 key

4. **Update Shift Document**
   ```javascript
   await shiftRef.update({
     zoom_meeting_id: meeting.id,
     zoom_encrypted_join_url: encryptedJoinUrl,
     zoom_meeting_created_at: admin.firestore.FieldValue.serverTimestamp(),
   });
   ```
   - Stores encrypted join URL (not plain text)
   - Stores meeting ID for reference

5. **Generate Time-Gated Join Token**
   ```javascript
   const allowedEndMs = shiftEnd.getTime() + 10 * 60 * 1000; // 10 min buffer
   const expSeconds = Math.floor((allowedEndMs + 5 * 60 * 1000) / 1000);
   
   const joinToken = signJoinToken(
     {shiftId, teacherId, exp: expSeconds}, 
     zoomConfig.joinTokenSecret
   );
   ```
   - Token expires 15 minutes after shift end
   - Includes shift ID and teacher ID for validation

6. **Build Join URL** (Firebase Function URL)
   ```javascript
   const joinLink = `${buildFunctionUrl('joinZoomMeeting')}?token=${encodeURIComponent(joinToken)}`;
   ```
   - URL format: `https://us-central1-alluwal-academy.cloudfunctions.net/joinZoomMeeting?token=...`
   - Teacher clicks this link, function validates token and redirects to actual Zoom

7. **Send Email to Teacher**
   - **From:** `support@alluwaleducationhub.org`
   - **Subject:** `ðŸ“… Zoom link for your shift (${subject})`
   - **Content:** 
     - Shift details (name, date/time in teacher's timezone)
     - Join button with secure link
     - Note: Link works from 10 minutes before start to 10 minutes after end
   - **File:** Uses nodemailer transporter

8. **Mark Invite as Sent**
   ```javascript
   await shiftRef.update({
     zoom_invite_sent_at: admin.firestore.FieldValue.serverTimestamp(),
   });
   ```

**Shift Document Fields (Zoom-related):**
- `zoom_meeting_id` (String) - Zoom's meeting ID
- `zoom_encrypted_join_url` (String) - Encrypted join URL
- `zoom_meeting_created_at` (Timestamp) - When meeting was created
- `zoom_invite_sent_at` (Timestamp) - When email was sent
- `zoom_error` (String, optional) - Error message if creation failed

**TeachingShift Model Fields:**
- `zoomMeetingId` (String?)
- `zoomEncryptedJoinUrl` (String?)
- `zoomMeetingCreatedAt` (DateTime?)
- `zoomInviteSentAt` (DateTime?)
- `hasZoomMeeting` (bool getter) - Returns `true` if `zoomMeetingId` exists

---

## Phase 3: Shift Status Transitions (Automated)

### At Shift Start Time

**Cloud Function:** `handleShiftStartTask`  
**File:** `functions/handlers/shifts.js`  
**Type:** HTTPS (`onRequest`)  
**Triggered by:** Cloud Task scheduled at `shiftStart` time

**Process:**

1. **Validates Request**
   - Checks HTTP method is POST
   - Extracts `shiftId` from request body

2. **Reads Shift Document**
   ```javascript
   const shiftDoc = await db.collection('teaching_shifts').doc(shiftId).get();
   ```

3. **Updates Status to Active**
   ```javascript
   if (shiftData.status === 'scheduled') {
     await shiftRef.update({
       status: 'active',
       activated_at: admin.firestore.FieldValue.serverTimestamp(),
     });
   }
   ```

**Note:** This does NOT clock the teacher in automatically. The teacher must still manually clock in via the app. This only marks the shift window as "active" (open for clock-in).

---

## Phase 4: Teacher Clock-In

### UI Entry Point

**File:** `lib/features/time_clock/screens/time_clock_screen.dart`

**User Flow:**

1. Teacher opens Time Clock screen
2. Taps "Clock In" button
3. Calls `_handleClockInOut()` (line ~710)

**Method Flow:**
```dart
_handleClockInOut()
  â†’ _checkShiftAndStartSession()      // Validates shift availability
    â†’ _startTeachingSession()          // Shows shift confirmation dialog
      â†’ _confirmAndClockIn()           // Performs actual clock-in
```

---

### _checkShiftAndStartSession()

**File:** `lib/features/time_clock/screens/time_clock_screen.dart`  
**Method:** `_checkShiftAndStartSession()` (line ~746)

**Process:**

1. **Gets Valid Shift for Clock-In**
   ```dart
   final shiftResult = await ShiftTimesheetService.getValidShiftForClockIn(user.uid);
   ```
   - Returns shift that teacher can clock into right now

2. **Validates Availability**
   - Checks if `canClockIn` is true
   - Validates shift exists and is assigned to teacher
   - Checks current time is within shift window

3. **Shows Shift Selection Dialog**
   - If multiple valid shifts, lets teacher choose
   - Otherwise proceeds automatically

---

### ShiftTimesheetService.getValidShiftForClockIn()

**File:** `lib/core/services/shift_timesheet_service.dart`  
**Method:** `getValidShiftForClockIn()` (line ~60)

**Process:**

1. **Queries Shifts**
   ```dart
   final shiftsSnapshot = await _firestore
       .collection('teaching_shifts')
       .where('teacher_id', isEqualTo: teacherId)
       .where('status', whereIn: ['scheduled', 'active'])
       .get();
   ```

2. **Filters for Valid Shifts**
   - Current time must be within shift window (`canClockIn` property)
   - No existing open timesheet entry for this shift
   - Shift must be assigned to the teacher

3. **Returns First Valid Shift**
   ```dart
   return {
     'shift': shift,
     'canClockIn': true,
     'canClockOut': false,
     'status': 'scheduled',
     'message': 'Ready to clock in to ${shift.displayName}',
   };
   ```

---

### ShiftTimesheetService.clockInToShift()

**File:** `lib/core/services/shift_timesheet_service.dart`  
**Method:** `clockInToShift()` (line ~140)

**Parameters:**
- `teacherId` (String)
- `shiftId` (String)
- `location` (LocationData) - Required
- `platform` (String?) - Optional (web/android/ios)

**Step-by-step:**

1. **Validates Shift**
   ```dart
   final shift = await _validateShiftForClockIn(teacherId, shiftId);
   ```
   - Ensures shift exists
   - Verifies teacher ownership
   - Checks shift is in valid state

2. **Checks for Existing Open Timesheet**
   ```dart
   final existingOpenTimesheet = await _findOpenTimesheetEntry(
     teacherId: teacherId,
     shiftId: shiftId,
   );
   ```
   - Query: `end_time == '' OR end_time == null`
   - Prevents duplicate clock-ins
   - Returns error if already clocked in

3. **Creates Timesheet Entry**
   ```dart
   final timesheetEntry = await _createTimesheetEntryFromShift(
     shift, 
     location,
     isClockIn: true,
     platform: platform,
   );
   ```
   - **Collection:** `timesheet_entries`
   - **Fields:**
     - `teacher_id` - Teacher UID
     - `shift_id` - Shift document ID
     - `clock_in_timestamp` - Server timestamp
     - `clock_in_location` - LocationData object
     - `clock_in_platform` - 'web', 'android', or 'ios'
     - `start_time` - Formatted time string (e.g., "2:30 PM")
     - `end_time` - Empty string (set on clock-out)
     - `date` - Date string
     - Shift metadata (subject, student names, etc.)

4. **Updates Shift Status**
   ```dart
   await ShiftService.clockIn(teacherId, shiftId, platform: platform);
   ```
   - Updates shift document (see next section)

5. **Returns Success Result**
   ```dart
   return {
     'success': true,
     'message': 'Clocked in successfully',
     'shift': shift,
     'timesheetEntry': timesheetEntry,
   };
   ```

---

### ShiftService.clockIn()

**File:** `lib/core/services/shift_service.dart`  
**Method:** `clockIn()` (line ~1150)

**Process:**

1. **Validates Shift Ownership**
   ```dart
   if (shift.teacherId != teacherId) {
     return false; // Not authorized
   }
   ```

2. **Checks for Conflicting Active Shifts**
   ```dart
   final otherOngoingSessions = await _getOtherActiveShiftsForTeacher(teacherId, excludeShiftId: shiftId);
   if (otherOngoingSessions.isNotEmpty) {
     return false; // Can't clock in to multiple shifts
   }
   ```

3. **Updates Shift Document**
   ```dart
   await _shiftsCollection.doc(shiftId).update({
     'status': ShiftStatus.active.name,      // Always set to active
     'clock_in_time': Timestamp.fromDate(now), // Record clock-in time
     'clock_out_time': null,                 // Clear any previous clock-out
     'last_clock_in_platform': platform,     // Track platform
     'last_modified': Timestamp.fromDate(now),
   });
   ```

**Result:** Shift status is now `active` with `clock_in_time` set.

**Note:** Timesheet entry and shift document are updated separately. The timesheet entry is the source of truth for worked hours.

---

## Phase 5: Accessing Zoom Meeting (During Shift)

### Zoom Screen UI

**File:** `lib/features/zoom/screens/zoom_screen.dart`

**Display Logic:**
- Shows shifts with Zoom meetings (`hasZoomMeeting == true`)
- Filters shifts within time window (past 7 days to future 30 days)
- Sorts by shift start time
- Each shift card shows join button if within time window

---

### ZoomService.joinMeetingInApp()

**File:** `lib/core/services/zoom_service.dart`  
**Method:** `joinMeetingInApp()` (line ~78)

**Process:**

1. **Validates Shift Has Zoom Meeting**
   ```dart
   if (!shift.hasZoomMeeting) {
     _showError(context, 'This shift does not have a Zoom meeting configured');
     return;
   }
   ```

2. **Checks Time Window**
   ```dart
   if (!canJoinMeeting(shift)) {
     final timeUntil = getTimeUntilCanJoin(shift);
     if (timeUntil != null) {
       _showError(context, 'You can join this meeting in $timeText (10 minutes before the shift starts)');
     } else {
       _showError(context, 'The meeting window for this shift has ended');
     }
     return;
   }
   ```
   - **Window:** 10 minutes before shift start to 10 minutes after shift end
   - Shows helpful message if outside window

3. **Shows Loading Indicator**
   - Displays circular progress indicator while fetching join URL

4. **Gets Join URL**
   ```dart
   final meetingUrl = await getJoinUrl(shift);
   ```

5. **Navigates to In-App Zoom Screen**
   ```dart
   await Navigator.of(context).push(
     MaterialPageRoute(
       builder: (context) => InAppZoomMeetingScreen(
         meetingUrl: meetingUrl,
         meetingId: shift.zoomMeetingId,
       ),
     ),
   );
   ```

---

### ZoomService.getJoinUrl()

**File:** `lib/core/services/zoom_service.dart`  
**Method:** `getJoinUrl()` (line ~16)

**Process:**

1. **Validates Shift Has Zoom**
   ```dart
   if (!shift.hasZoomMeeting) {
     throw Exception('This shift does not have a Zoom meeting configured');
   }
   ```

2. **Calls Cloud Function**
   ```dart
   final callable = _functions.httpsCallable('getZoomJoinUrl');
   final result = await callable.call({'shiftId': shift.id});
   ```

3. **Extracts Join URL**
   ```dart
   final data = result.data as Map<String, dynamic>;
   if (data['success'] == true && data['joinUrl'] != null) {
     return data['joinUrl'] as String;
   }
   ```

**Cloud Function:** `functions/handlers/zoom.js` - `getZoomJoinUrl` (line ~157)

---

### Cloud Function: getZoomJoinUrl

**File:** `functions/handlers/zoom.js`  
**Function:** `getZoomJoinUrl` (line ~157)  
**Type:** Callable (`onCall`)

**Process:**

1. **Validates Input**
   ```javascript
   const shiftId = request.data?.shiftId;
   const teacherId = request.auth?.uid; // From Firebase Auth
   ```

2. **Reads Shift Document**
   ```javascript
   const shiftDoc = await admin.firestore()
       .collection('teaching_shifts')
       .doc(shiftId)
       .get();
   ```

3. **Verifies Teacher Authorization**
   ```javascript
   if (teacherId && shiftData.teacher_id && teacherId !== shiftData.teacher_id) {
     throw new Error('Not authorized for this shift');
   }
   ```

4. **Checks Zoom Meeting Exists**
   ```javascript
   if (!shiftData.zoom_meeting_id || !shiftData.zoom_encrypted_join_url) {
     throw new Error('Zoom meeting not available for this shift');
   }
   ```

5. **Validates Time Window**
   ```javascript
   const now = new Date();
   const allowedStartMs = shiftStart.getTime() - 10 * 60 * 1000; // 10 min before
   const allowedEndMs = shiftEnd.getTime() + 10 * 60 * 1000;    // 10 min after
   
   if (now.getTime() < allowedStartMs || now.getTime() > allowedEndMs) {
     throw new Error('Zoom link is only available from 10 minutes before shift start to 10 minutes after shift end');
   }
   ```

6. **Decrypts Join URL**
   ```javascript
   joinUrl = decryptString(
     shiftData.zoom_encrypted_join_url, 
     zoomConfig.encryptionKeyB64
   );
   ```
   - Decrypts the stored encrypted URL to get actual Zoom join URL

7. **Generates Time-Gated Token**
   ```javascript
   const allowedEndMsForToken = shiftEnd.getTime() + 10 * 60 * 1000;
   const expSeconds = Math.floor((allowedEndMsForToken + 5 * 60 * 1000) / 1000);
   
   const joinToken = signJoinToken(
     {shiftId, teacherId: teacherId || shiftData.teacher_id, exp: expSeconds},
     zoomConfig.joinTokenSecret
   );
   ```

8. **Builds Function URL**
   ```javascript
   const projectId = process.env.GCLOUD_PROJECT || 'alluwal-academy';
   const region = 'us-central1';
   const joinUrl = `https://${region}-${projectId}.cloudfunctions.net/joinZoomMeeting?token=${encodeURIComponent(joinToken)}`;
   ```

9. **Returns Response**
   ```javascript
   return {
     success: true,
     joinUrl,
     meetingId: shiftData.zoom_meeting_id,
   };
   ```

---

### joinZoomMeeting Function (HTTP Redirect)

**File:** `functions/handlers/zoom.js`  
**Function:** `joinZoomMeeting` (line ~43)  
**Type:** HTTPS (`onRequest`)

**Purpose:** Validates token and redirects to actual Zoom join URL

**Process:**

1. **Extracts Token from Query**
   ```javascript
   const token = req.query?.token;
   ```

2. **Validates Token**
   ```javascript
   const payload = verifyJoinToken(token, zoomConfig.joinTokenSecret);
   ```
   - Verifies signature
   - Checks expiration
   - Extracts `shiftId` and `teacherId`

3. **Validates Shift**
   - Checks shift exists
   - Verifies teacher authorization
   - Checks time window again

4. **Decrypts Actual Zoom URL**
   ```javascript
   joinUrl = decryptString(encryptedJoinUrl, zoomConfig.encryptionKeyB64);
   ```

5. **Redirects to Zoom**
   ```javascript
   res.redirect(302, joinUrl);
   ```
   - HTTP 302 redirect to Zoom's join URL
   - User joins meeting in browser or Zoom app

---

### In-App Zoom Meeting Screen

**File:** `lib/features/zoom/screens/in_app_zoom_meeting_screen.dart`

**Features:**
- WebView that loads the join URL
- Mobile-optimized UI
- Fullscreen mode support
- Handles Zoom deep links (`zoomus://`)

**Process:**

1. **Loads Join URL in WebView**
   ```dart
   _controller.loadRequest(Uri.parse(widget.meetingUrl));
   ```

2. **Handles Navigation**
   - Allows Zoom-related URLs
   - Blocks unsupported protocols

3. **Handles Zoom App Deep Link**
   ```dart
   if (request.url.startsWith('zoomus://')) {
     _launchZoomApp(request.url); // Opens native Zoom app
     return NavigationDecision.prevent; // Prevents WebView navigation
   }
   ```

4. **Launches Native Zoom App** (if available)
   ```dart
   final launched = await launchUrl(
     uri,
     mode: LaunchMode.externalApplication,
   );
   if (launched && mounted) {
     Navigator.of(context).pop(); // Closes WebView screen
   }
   ```

**Result:** Teacher can join Zoom meeting either in-app (WebView) or via native Zoom app.

---

## Phase 6: Shift Completion (Automated)

### At Shift End Time

**Cloud Function:** `handleShiftEndTask`  
**File:** `functions/handlers/shifts.js`  
**Type:** HTTPS (`onRequest`)  
**Triggered by:** Cloud Task scheduled at `shiftEnd` time

**Process:**

1. **Validates Request**
   - Checks HTTP method is POST
   - Extracts `shiftId` from request body

2. **Reads Shift Document**

3. **Finds Open Timesheet Entries**
   ```javascript
   const openEntries = await db.collection('timesheet_entries')
       .where('shift_id', '==', shiftId)
       .where('end_time', '==', '')
       .get();
   ```

4. **Auto-Clocks Out Open Entries**
   - Sets `end_time` to current time
   - Calculates worked duration
   - Updates timesheet entry

5. **Calculates Total Worked Minutes**
   ```javascript
   let totalWorkedMinutes = 0;
   // Sum all timesheet entries for this shift
   ```

6. **Determines Final Status**
   ```javascript
   if (!hasClockIn || totalWorkedMinutes == 0) {
     newStatus = 'missed';
     completionState = 'none';
   } else if (totalWorkedMinutes + toleranceMinutes >= scheduledMinutes) {
     newStatus = 'fullyCompleted';
     completionState = 'full';
   } else {
     newStatus = 'partiallyCompleted';
     completionState = 'partial';
   }
   ```

7. **Updates Shift Document**
   ```javascript
   await shiftRef.update({
     status: newStatus,
     worked_minutes: totalWorkedMinutes,
     completion_state: completionState,
     auto_clock_out: true,
     auto_clock_out_reason: 'Shift end time reached',
   });
   ```

**Status Classifications:**
- `missed` - No clock-in occurred
- `partiallyCompleted` - Some work logged, but less than scheduled duration
- `fullyCompleted` - Worked minutes meet or exceed scheduled duration

---

## File Reference Summary

### Core Services
- `lib/core/services/shift_service.dart` - Shift CRUD operations, conflict detection, status management
- `lib/core/services/shift_timesheet_service.dart` - Clock-in/out logic, timesheet creation
- `lib/core/services/zoom_service.dart` - Zoom join URL retrieval, meeting access

### Models
- `lib/core/models/teaching_shift.dart` - Shift data model with Zoom fields and status logic
- `lib/core/models/enhanced_recurrence.dart` - Recurrence pattern model

### UI Screens
- `lib/features/shift_management/widgets/create_shift_dialog.dart` - Shift creation/editing form
- `lib/features/time_clock/screens/time_clock_screen.dart` - Clock-in/out UI
- `lib/features/zoom/screens/zoom_screen.dart` - Zoom meeting list UI
- `lib/features/zoom/screens/in_app_zoom_meeting_screen.dart` - In-app Zoom WebView

### Cloud Functions
- `functions/handlers/shifts.js` - Shift lifecycle tasks (`scheduleShiftLifecycle`, `handleShiftStartTask`, `handleShiftEndTask`)
- `functions/services/zoom/shift_zoom.js` - Zoom meeting creation (`ensureZoomMeetingAndEmailTeacher`)
- `functions/handlers/zoom.js` - Zoom join URL generation (`getZoomJoinUrl`, `joinZoomMeeting`)
- `functions/services/zoom/client.js` - Zoom API client
- `functions/services/zoom/crypto.js` - Encryption/decryption utilities
- `functions/services/zoom/config.js` - Zoom configuration loader

### Firestore Collections
- `teaching_shifts` - Shift documents
- `timesheet_entries` - Clock-in/out records
- `users` - Teacher/student data

---

## Data Flow Diagram

```
Admin Creates Shift
  â†“
ShiftService.createShift()
  â†“
Firestore: teaching_shifts/{shiftId} (status: 'scheduled')
  â†“
scheduleShiftLifecycle() Cloud Function
  â”œâ”€â†’ Cloud Task: Start (scheduled for shiftStart)
  â””â”€â†’ Cloud Task: End (scheduled for shiftEnd)
      â†“
  ensureZoomMeetingAndEmailTeacher()
      â”œâ”€â†’ Zoom API: Create Meeting
      â”œâ”€â†’ Firestore: Update shift with zoom_meeting_id, zoom_encrypted_join_url
      â””â”€â†’ Email: Send join link to teacher

[Time passes...]

Cloud Task: Start executes
  â†“
handleShiftStartTask()
  â†“
Firestore: Update shift (status: 'active')

[Teacher clocks in via app]
  â†“
ShiftTimesheetService.clockInToShift()
  â”œâ”€â†’ Firestore: timesheet_entries/{entryId} (clock_in_timestamp set)
  â””â”€â†’ ShiftService.clockIn()
      â””â”€â†’ Firestore: Update shift (clock_in_time set)

[Teacher joins Zoom]
  â†“
ZoomService.getJoinUrl()
  â†“
getZoomJoinUrl() Cloud Function
  â”œâ”€â†’ Decrypt zoom_encrypted_join_url
  â”œâ”€â†’ Generate time-gated token
  â””â”€â†’ Return function URL
      â†“
joinZoomMeeting() HTTP Function
  â”œâ”€â†’ Validate token
  â””â”€â†’ Redirect to Zoom join URL

[Time passes...]

Cloud Task: End executes
  â†“
handleShiftEndTask()
  â”œâ”€â†’ Auto-clock-out open timesheet entries
  â”œâ”€â†’ Calculate worked minutes
  â”œâ”€â†’ Determine status (missed/partiallyCompleted/fullyCompleted)
  â””â”€â†’ Firestore: Update shift (status, worked_minutes, completion_state)
```

---

## Key Concepts

### Shift Status Lifecycle
1. `scheduled` - Initial state when created
2. `active` - Shift window is open (set at shift start time or on clock-in)
3. `fullyCompleted` - Teacher worked full duration
4. `partiallyCompleted` - Teacher worked but less than scheduled
5. `missed` - No clock-in occurred
6. `cancelled` - Admin cancelled the shift

### Zoom Security
- Join URLs are **encrypted** before storing in Firestore
- Time-gated **tokens** restrict access to shift time window
- Tokens include shift ID and teacher ID for authorization
- Actual Zoom URL is never exposed to client until token validation

### Clock-In Window
- Teacher can clock in from **shift start time** to **shift end time**
- No grace period - must be within exact window
- System automatically clocks out at shift end time

### Timesheet vs Shift
- **Shift** = Scheduled appointment (status, metadata)
- **Timesheet Entry** = Actual work record (clock-in/out times, location)
- Worked hours are calculated from timesheet entries
- Shift status reflects completion based on timesheet data

---

## Error Handling

### Shift Creation Errors
- **Conflict detected:** Rollback shift creation, show error to admin
- **Lifecycle scheduling fails:** Rollback shift creation
- **Zoom creation fails:** Log error, continue with shift creation (non-blocking)

### Clock-In Errors
- **No valid shift:** Show "No active shift" message
- **Already clocked in:** Show "Already clocked in" message
- **Outside time window:** Show "Shift not available" message
- **Conflict with other shift:** Show "Another shift is active" message

### Zoom Access Errors
- **No Zoom meeting:** Show "Zoom meeting not configured"
- **Outside time window:** Show countdown or "Meeting window ended"
- **Token expired:** Cloud Function returns error, show in UI
- **Decryption fails:** Cloud Function logs error, returns error to client

---

This documentation provides a complete reference for understanding how shifts flow from creation to clock-in, including all Zoom integration details. Each phase builds on the previous one, with automated lifecycle management handling status transitions and Zoom meeting setup happening seamlessly in the background.
