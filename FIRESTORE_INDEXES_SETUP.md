# üî• Firestore Indexes Setup Guide

## Overview
Two composite indexes are required for the form system to work properly. These indexes enable efficient queries for:
1. **Form submissions tracking** (checking if forms are submitted)
2. **Shift selection** (finding available shifts for daily reports)

---

## ‚ö†Ô∏è Required Indexes

### 1. Index for `form_responses` Collection

**Query Pattern:**
```dart
FirebaseFirestore.instance
  .collection('form_responses')
  .where('userId', isEqualTo: userId)
  .where('formType', isEqualTo: 'daily')
  .where('submittedAt', isGreaterThanOrEqualTo: timestamp)
  .orderBy('submittedAt', descending: true)
```

**Index Configuration:**
- **Collection**: `form_responses`
- **Fields**:
  - `userId` (Ascending)
  - `formType` (Ascending)
  - `submittedAt` (Descending)

**Create Index:**
üëâ [Click here to create this index](https://console.firebase.google.com/v1/r/project/alluwal-academy/firestore/indexes?create_composite=ClZwcm9qZWN0cy9hbGx1d2FsLWFjYWRlbXkvZGF0YWJhc2VzLyhkZWZhdWx0KS9jb2xsZWN0aW9uR3JvdXBzL2Zvcm1fcmVzcG9uc2VzL2luZGV4ZXMvXxABGgwKCGZvcm1UeXBlEAEaCgoGdXNlcklkEAEaEQoNc3VibWl0dGVkRGF0ZRABGgwKCF9fbmFtZV9fEAE)

---

### 2. Index for `teaching_shifts` Collection

**Query Pattern:**
```dart
FirebaseFirestore.instance
  .collection('teaching_shifts')
  .where('teacherId', isEqualTo: userId)
  .where('shift_start', isGreaterThanOrEqualTo: timestamp)
  .orderBy('shift_start', descending: true)
```

**Index Configuration:**
- **Collection**: `teaching_shifts`
- **Fields**:
  - `teacherId` (Ascending)
  - `shift_start` (Ascending)

**Create Index:**
üëâ [Click here to create this index](https://console.firebase.google.com/v1/r/project/alluwal-academy/firestore/indexes?create_composite=Cldwcm9qZWN0cy9hbGx1d2FsLWFjYWRlbXkvZGF0YWJhc2VzLyhkZWZhdWx0KS9jb2xsZWN0aW9uR3JvdXBzL3RlYWNoaW5nX3NoaWZ0cy9pbmRleGVzL18QARoNCgl0ZWFjaGVySWQQARoPCgtzaGlmdF9zdGFydBACGgwKCF9fbmFtZV9fEAI)

---

## üöÄ Setup Methods

### Method 1: Firebase Console (Easiest)
1. Click on the links above for each index
2. Review the index configuration
3. Click "Create Index"
4. Wait for the index to build (usually 1-5 minutes)
5. Check status in Firebase Console ‚Üí Firestore ‚Üí Indexes

### Method 2: Firebase CLI
1. Run the script to generate `firestore.indexes.json`:
   ```bash
   node scripts/create_firestore_indexes.js
   ```

2. Deploy the indexes:
   ```bash
   firebase deploy --only firestore:indexes
   ```

3. Wait for indexes to build (check status in console)

### Method 3: Manual Creation
1. Go to [Firebase Console](https://console.firebase.google.com/project/alluwal-academy/firestore/indexes)
2. Click "Create Index"
3. For each index:
   - Select the collection
   - Add fields in the correct order
   - Set field order (Ascending/Descending)
   - Click "Create"

---

## ‚úÖ Verification

After creating the indexes, verify they're working:

1. **Check Index Status:**
   - Go to Firebase Console ‚Üí Firestore ‚Üí Indexes
   - Look for "Enabled" status (green checkmark)

2. **Test the App:**
   - Open the Forms screen
   - Check that submission status loads without errors
   - Try selecting a shift for Daily Class Report
   - Verify no Firestore index errors in console

---

## üêõ Troubleshooting

### Error: "The query requires an index"
- **Solution**: Make sure you've created the index and it's enabled
- **Check**: Firebase Console ‚Üí Firestore ‚Üí Indexes ‚Üí Status should be "Enabled"

### Error: "Index is still building"
- **Solution**: Wait a few minutes for the index to finish building
- **Check**: Refresh the Firebase Console to see updated status

### Error: "Index creation failed"
- **Solution**: 
  - Check that field names match exactly (case-sensitive)
  - Verify collection names are correct
  - Make sure you have proper permissions

### Still seeing errors after creating indexes?
- Clear app cache and restart
- Check that the index is for the correct collection
- Verify field types match (String, Timestamp, etc.)

---

## üìù Index Details

### Index 1: form_responses
```json
{
  "collectionGroup": "form_responses",
  "queryScope": "COLLECTION",
  "fields": [
    {
      "fieldPath": "userId",
      "order": "ASCENDING"
    },
    {
      "fieldPath": "formType",
      "order": "ASCENDING"
    },
    {
      "fieldPath": "submittedAt",
      "order": "DESCENDING"
    }
  ]
}
```

### Index 2: teaching_shifts
```json
{
  "collectionGroup": "teaching_shifts",
  "queryScope": "COLLECTION",
  "fields": [
    {
      "fieldPath": "teacherId",
      "order": "ASCENDING"
    },
    {
      "fieldPath": "shift_start",
      "order": "ASCENDING"
    }
  ]
}
```

---

## üîó Related Files

- `scripts/create_firestore_indexes.js` - Script to generate index definitions
- `firestore.indexes.json` - Index configuration file (generated by script)
- `lib/features/forms/screens/teacher_forms_screen.dart` - Uses these indexes

---

**Last Updated**: January 8, 2026  
**Status**: ‚ö†Ô∏è Indexes must be created before using the form system
