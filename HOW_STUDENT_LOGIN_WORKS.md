# How Student Login Works

## Overview
Students don't have real email accounts. Instead, they use their **Student ID** (like "test.student") which gets converted to an alias email for Firebase Authentication.

## The Login Process

### Step 1: Student Enters Credentials
- Student enters their **Student ID** (e.g., "test.student")
- Student enters their **Password**

### Step 2: Student ID Conversion
The system converts the Student ID to an alias email:
```
Student ID: "test.student"
  ↓ (convert to lowercase)
"test.student"
  ↓ (add domain)
"test.student@alluwaleducationhub.org"
```

**Code location:** `lib/features/auth/screens/mobile_login_screen.dart:64-67`

### Step 3: Firebase Authentication
The system calls Firebase Auth's `signInWithEmailAndPassword()` with:
- **Email:** `test.student@alluwaleducationhub.org`
- **Password:** The password the student entered

**Code location:** `lib/core/services/auth_service.dart:18-22`

## Account Setup

### When a Student is Created:

1. **Student Code Generated**
   - Format: `firstname.lastname` (e.g., "test.student")
   - Stored in Firestore: `student_code` field

2. **Firebase Auth Account Created**
   - Email: `{student_code}@alluwaleducationhub.org` (lowercase)
   - Password: Random generated password
   - UID: Generated by Firebase Auth
   - **Code:** `functions/handlers/students.js:105-110`

3. **Firestore Document Created**
   - Document ID: Same as Firebase Auth UID
   - Fields:
     - `student_code`: "test.student"
     - `temp_password`: The same password as Firebase Auth
     - `user_type`: "student"
     - `e-mail`: "test.student@alluwaleducationhub.org"
   - **Code:** `functions/handlers/students.js:132-155`

## Why "test.student" Works

`test.student` can login because:
1. ✅ Firebase Auth account exists with email `test.student@alluwaleducationhub.org`
2. ✅ The password in Firebase Auth matches what's stored in Firestore `temp_password`
3. ✅ When student enters "test.student" as Student ID, it converts correctly to the alias email
4. ✅ Firebase Auth signInWithEmailAndPassword succeeds

## Why Other Students Might Not Work

Other students cannot login if:
1. ❌ **Password Mismatch**: Firebase Auth password ≠ Firestore `temp_password`
   - This happens if password was changed in one place but not the other
   - **Fix**: Run password reset to sync them

2. ❌ **Missing Firebase Auth Account**: Old students might not have Firebase Auth accounts
   - **Fix**: Password reset function now creates the account if missing

3. ❌ **Email Format Mismatch**: Case sensitivity or formatting issues
   - **Fix**: Login always converts to lowercase, so this should be consistent

## Password Reset Process

When an admin resets a student's password:

1. **Generate New Password**: Random password generated
2. **Update Firebase Auth**: 
   - If account exists → Update password
   - If account missing → Create account with same UID as Firestore document
   - **Code:** `functions/handlers/password.js:102-140`

3. **Update Firestore**: Store new password in `temp_password` field
4. **Email Parent**: Optionally send credentials to parent

**Code location:** `functions/handlers/password.js`

## Key Files

- **Login Screen (Mobile):** `lib/features/auth/screens/mobile_login_screen.dart`
- **Login Screen (Web):** `lib/main.dart` (EmployeeHubApp class)
- **Auth Service:** `lib/core/services/auth_service.dart`
- **Student Creation:** `functions/handlers/students.js`
- **Password Reset:** `functions/handlers/password.js`

## Testing

Run the test script to verify student setup:
```bash
cd functions
node test_student_login.js
```

This will show:
- Which students have Firebase Auth accounts
- If UIDs match between Firestore and Firebase Auth
- If temp_password exists in Firestore

## Summary

**Student Login Flow:**
```
Student ID → lowercase → add @alluwaleducationhub.org → Firebase Auth signIn
```

**Requirements:**
1. Firebase Auth account with alias email exists
2. Password in Firebase Auth matches what student enters
3. Firestore document with matching student_code exists
4. UIDs match between Firestore and Firebase Auth (for proper data linking)

